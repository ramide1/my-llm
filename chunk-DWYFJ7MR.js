import{a as re}from"./chunk-PQOTB3YC.js";import{a as oe}from"./chunk-YLQAGAQS.js";import{$,A as j,B as A,C as R,D as F,G as H,N as L,O as Q,P as q,Q as J,R as z,S as G,T as K,Y as X,Z as Y,_ as Z,aa as ee,c as b,ca as te,e as v,f as C,fa as ie,g as r,h as m,i as I,j as x,ja as ne,k as P,ka as ae,l as E,m as O,n as T,na as se,o as p,p as i,q as a,r as D,ra as ce,s as N,t as B,u as W,v as U,w as V,x as k,y as l,z as u}from"./chunk-WAVSKRIQ.js";import"./chunk-4V35YC6W.js";import"./chunk-YORAWLNR.js";import"./chunk-HDEJMFIX.js";import"./chunk-GXTZMCAG.js";import"./chunk-TJXAWC6C.js";import"./chunk-CEU2YL57.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-DVVH2KKN.js";import"./chunk-NV3QH4JK.js";import"./chunk-PIQNUW7X.js";import"./chunk-OZYWYLNK.js";import"./chunk-42C7ZIID.js";import{h,i as _}from"./chunk-LUL4G5ZA.js";var he=["main"];function me(c,s){if(c&1&&(i(0,"li")(1,"span"),l(2),a(),i(3,"p"),l(4),a()()),c&2){let f=s.$implicit;k(F("message ",f.role=="assistant"?"bot":"user")),r(2),u(f.role=="assistant"?"Llm":"User"),r(2),u(f.content)}}function pe(c,s){c&1&&(i(0,"li",5)(1,"span"),l(2,"Llm"),a(),i(3,"p"),l(4,"Typing..."),a()())}var Oe=(()=>{let s=class s{constructor(n,t,e){this.chatsService=n,this.configService=t,this.alertService=e,this.chat={id:crypto.randomUUID(),title:"New Chat",messages:[{id:crypto.randomUUID(),role:"assistant",content:"Hi! How can i help you today?",created:new Date}],created:new Date},this.currentMessage="",this.isSending=!1,this.isWriting=!1,this.chatId="",this.activatedRoute=b(H);let o=this.activatedRoute.snapshot.paramMap.get("id");o!==""&&o!==null&&(this.chatId=o)}ngOnInit(){return h(this,null,function*(){yield this.getChat(),this.scrollToBottom()})}getChat(){return h(this,null,function*(){try{if(this.chatId!==""){let t=this.chatsService.getChat(this.chatId);t!==null&&(this.chat=t)}if(!(yield this.configService.getConfig()))throw new Error("Error loading config")}catch(n){yield this.alertService.presentAlert(n.message,"Error")}})}scrollToBottom(){let n=this.main.nativeElement;n.scrollTop=n.scrollHeight}onSubmit(){return h(this,null,function*(){try{this.isSending=!0,this.isWriting=!0;let d=this.currentMessage;if(this.currentMessage="",this.chatId===""){if(this.chat.title=d,!(yield this.chatsService.addChat(this.chat)))throw new Error("Error saving chat");this.chatId=this.chat.id}let g={id:crypto.randomUUID(),role:"user",content:d,created:new Date};if(!(yield this.chatsService.addMessage(this.chatId,g)))throw new Error("Error saving user message");let w=yield fetch(this.configService.config.api_url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.configService.config.selected_model,messages:this.chat.messages,stream:!0})});if(!w.ok)throw new Error("Api response was not ok");let M={id:crypto.randomUUID(),role:"assistant",content:"",created:new Date};if(!(yield this.chatsService.addMessage(this.chatId,M)))throw new Error("Error saving bot message");this.isSending=!1;let S="";try{for(var n=_(w.body.pipeThrough(new TextDecoderStream)),t,e,o;t=!(e=yield n.next()).done;t=!1){let y=e.value;let le=y.trim().split("data: ")[1],[de]=JSON.parse(le).choices,ge=de?.delta?.content??"";S+=ge,M.content=S,this.scrollToBottom()}}catch{o=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(o)throw o[0]}}if(!(yield this.chatsService.updateChats()))throw new Error("Error updating chats");this.isWriting=!1}catch(d){this.isSending=!1,this.isWriting=!1,yield this.alertService.presentAlert(d.message,"Error")}})}};s.\u0275fac=function(t){return new(t||s)(m(oe),m(re),m(ce))},s.\u0275cmp=I({type:s,selectors:[["app-chats"]],viewQuery:function(t,e){if(t&1&&W(he,5),t&2){let o;U(o=V())&&(e.main=o.first)}},decls:21,vars:6,consts:[["main",""],[3,"translucent"],["slot","start"],[3,"fullscreen"],[3,"class"],[1,"message","bot"],[3,"ngSubmit"],["name","message","labelPlacement","floating","placeholder","Write your message here...","required","",3,"ngModelChange","ngModel"],["slot","label"],["expand","block","type","submit",3,"disabled"]],template:function(t,e){if(t&1){let o=N();i(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-buttons",2),D(3,"ion-menu-button"),a(),i(4,"ion-title"),l(5),a()()(),i(6,"ion-content",3)(7,"main",null,0)(9,"ul"),O(10,me,5,5,"li",4,E),x(12,pe,5,0,"li",5),a()(),i(13,"form",6),B("ngSubmit",function(){return v(o),C(e.onSubmit())}),i(14,"ion-list")(15,"ion-item")(16,"ion-input",7),R("ngModelChange",function(g){return v(o),A(e.currentMessage,g)||(e.currentMessage=g),C(g)}),i(17,"div",8),l(18,"Message"),a()()()(),i(19,"ion-button",9),l(20,"Send"),a()()()}t&2&&(p("translucent",!0),r(5),u(e.chat.title),r(),p("fullscreen",!0),r(4),T(e.chat.messages),r(2),P(e.isSending&&e.isWriting?12:-1),r(4),j("ngModel",e.currentMessage),r(3),p("disabled",e.currentMessage.trim()===""||e.isWriting))},dependencies:[$,ae,Y,ie,ne,Z,se,te,ee,X,K,z,L,Q,G,J,q],styles:["ion-menu-button[_ngcontent-%COMP%]{color:var(--ion-color-primary)}main[_ngcontent-%COMP%]{height:82vh;border:1px solid #ccc;border-radius:4px;box-shadow:0 0 10px #0000001a;padding:8px;overflow-y:auto;scroll-behavior:smooth}ul[_ngcontent-%COMP%]{display:flex;flex-direction:column;list-style:none;padding:0}.message[_ngcontent-%COMP%]{display:flex;flex-direction:column;margin:4px 0;padding:4px 8px}.message[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{width:36px;height:36px;background:#eee;font-size:12px;font-weight:500;display:flex;justify-content:center;align-items:center;border-radius:999999px}.message[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{border-radius:4px;padding:4px 8px;margin-top:4px}.message.user[_ngcontent-%COMP%]{align-self:flex-end;align-items:flex-end}.message.user[_ngcontent-%COMP%]   span[_ngcontent-%COMP%], .message.user[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{background:#00f}.message.bot[_ngcontent-%COMP%]{align-self:flex-start}.message.bot[_ngcontent-%COMP%]   span[_ngcontent-%COMP%], .message.bot[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{background:green}"]});let c=s;return c})();export{Oe as ChatsPage};
